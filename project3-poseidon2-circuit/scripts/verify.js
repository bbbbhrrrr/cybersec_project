const fs = require('fs');
const path = require('path');
const snarkjs = require('snarkjs');

/*
 * Verify Zero-Knowledge Proof
 * 
 * This script verifies a Groth16 proof generated by the prove script.
 * It demonstrates the verification process for zero-knowledge proofs.
 */

async function main() {
    console.log('ğŸ” Verifying Zero-Knowledge Proof...\n');
    
    const setupDir = path.join(__dirname, '../setup');
    const proofsDir = path.join(__dirname, '../proofs');
    
    const vkeyPath = path.join(setupDir, 'verification_key.json');
    const proofPath = path.join(proofsDir, 'proof.json');
    const publicPath = path.join(proofsDir, 'public.json');
    
    // Check required files
    if (!fs.existsSync(vkeyPath)) {
        console.error('âŒ Verification key not found. Please run setup script first.');
        process.exit(1);
    }
    
    if (!fs.existsSync(proofPath)) {
        console.error('âŒ Proof not found. Please run prove script first.');
        process.exit(1);
    }
    
    if (!fs.existsSync(publicPath)) {
        console.error('âŒ Public inputs not found. Please run prove script first.');
        process.exit(1);
    }
    
    try {
        console.log('ğŸ“ Verification key:', vkeyPath);
        console.log('ğŸ“ Proof file:', proofPath);
        console.log('ğŸ“ Public inputs:', publicPath);
        console.log();
        
        // Load verification artifacts
        console.log('ğŸ“– Loading verification artifacts...');
        const vKey = JSON.parse(fs.readFileSync(vkeyPath));
        const proof = JSON.parse(fs.readFileSync(proofPath));
        const publicSignals = JSON.parse(fs.readFileSync(publicPath));
        
        console.log('  âœ… Verification key loaded');
        console.log('  âœ… Proof loaded');
        console.log('  âœ… Public inputs loaded');
        
        // Show verification details
        console.log('\nğŸ“Š Verification Details:');
        console.log(`  ğŸ¯ Public hash: ${publicSignals[0]}`);
        console.log(`  ğŸ“ Proof size: ${JSON.stringify(proof).length} bytes`);
        console.log(`  ğŸ”¢ Public signals count: ${publicSignals.length}`);
        
        // Perform verification
        console.log('\nâš™ï¸  Verifying proof...');
        const startTime = Date.now();
        
        const isValid = await snarkjs.groth16.verify(vKey, publicSignals, proof);
        
        const verifyTime = Date.now() - startTime;
        console.log(`  â±ï¸  Verification time: ${verifyTime}ms`);
        
        // Show verification result
        console.log('\nğŸ¯ Verification Result:');
        if (isValid) {
            console.log('  âœ… PROOF IS VALID');
            console.log('  ğŸ”’ The prover knows the preimage of the hash');
            console.log('  ğŸ›¡ï¸  No information about the preimage was revealed');
        } else {
            console.log('  âŒ PROOF IS INVALID');
            console.log('  ğŸš« The proof verification failed');
        }
        
        // Performance summary
        console.log('\nğŸ“ˆ Performance Summary:');
        console.log(`  âš¡ Verification time: ${verifyTime}ms`);
        console.log(`  ğŸ“¦ Proof size: ${JSON.stringify(proof).length} bytes`);
        console.log(`  ğŸ”¢ Gas cost estimate: ~250,000 gas (on Ethereum)`);
        
        // Security analysis
        console.log('\nğŸ›¡ï¸  Security Properties:');
        console.log('  âœ… Zero-knowledge: Preimage remains hidden');
        console.log('  âœ… Soundness: Invalid proofs are rejected');
        console.log('  âœ… Completeness: Valid proofs are accepted');
        console.log('  ğŸ” Cryptographic assumptions: Discrete log, knowledge-of-exponent');
        
        // Generate verification report
        const reportPath = path.join(proofsDir, 'verification_report.json');
        const report = {
            timestamp: new Date().toISOString(),
            isValid: isValid,
            verificationTime: verifyTime,
            proofSize: JSON.stringify(proof).length,
            publicHash: publicSignals[0],
            publicSignalsCount: publicSignals.length
        };
        
        fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
        console.log('\nğŸ“„ Verification report saved to verification_report.json');
        
    } catch (error) {
        console.error('âŒ Verification failed:');
        console.error(error.message);
        process.exit(1);
    }
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = { main };
